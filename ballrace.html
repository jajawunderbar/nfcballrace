<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>NFC Race Timer (2 Balls)</title>
  <style>
    :root {
      --bg: #0b0f14;
      --card: #10161d;
      --muted: #6b7a90;
      --text: #e7eef7;
      --accentA: #47d7ac;
      --accentB: #7ba6ff;
      --accentWarn: #ffb020;
      --accentErr: #ff6b6b;
      --ring: rgba(123,166,255,0.35);
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 50% -20%, #1a2230 0%, #0b0f14 60%);
      color: var(--text);
    }
    .wrap { padding: 16px; max-width: 900px; margin: 0 auto; }
    header { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    h1 { font-size: 1.35rem; margin: 0; letter-spacing: .3px; }
    .pill { padding: 6px 10px; border-radius: 999px; background: #0f141b; color: var(--muted); font-size: .85rem; border: 1px solid #1b2430; }

    .grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-top: 12px; }
    @media (min-width: 720px) { .grid { grid-template-columns: 1.1fr .9fr; } }

    .card { background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border: 1px solid #1b2430; border-radius: 16px; padding: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.35);
      position: relative; overflow: hidden; }
    .card:before { content: ""; position: absolute; inset: -2px; border-radius: 18px; padding: 1px; background: radial-gradient(600px 300px at 50% -60%, var(--ring), transparent 60%); -webkit-mask: linear-gradient(#000 0 0) content-box, linear-gradient(#000 0 0); -webkit-mask-composite: xor; mask-composite: exclude; pointer-events: none; }

    .row { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    .grow { flex: 1 1 auto; }

    button {
      appearance: none; border: 1px solid #1b2430; background: #111722; color: var(--text);
      padding: 12px 14px; border-radius: 12px; font-weight: 600; letter-spacing: .2px; font-size: 1rem;
      box-shadow: 0 8px 20px rgba(0,0,0,.25);
    }
    button.big { font-size: 1.15rem; padding: 14px 16px; }
    button:disabled { opacity: .5; }
    button.primary { background: linear-gradient(180deg, #1b2330, #0f1622); border-color: #263145; }
    button.ghost { background: transparent; }

    .status {
      font-size: .95rem; color: var(--muted); padding: 6px 10px; border-radius: 10px; border: 1px dashed #243044; background: rgba(18,24,34,.6);
    }

    .lane { display: grid; grid-template-columns: 1fr auto; align-items: center; gap: 8px; padding: 10px; border-radius: 12px; border: 1px solid #182133; }
    .lane h3 { margin: 0; font-size: 1.05rem; }
    .lane small { color: var(--muted); }
    .lane .badge { padding: 3px 8px; border-radius: 999px; font-weight: 700; letter-spacing: .3px; }
    .a { background: rgba(71,215,172,.08); border-color: rgba(71,215,172,.25); }
    .a .badge { background: rgba(71,215,172,.15); color: var(--accentA); border: 1px solid rgba(71,215,172,.35); }
    .b { background: rgba(123,166,255,.07); border-color: rgba(123,166,255,.25); }
    .b .badge { background: rgba(123,166,255,.14); color: var(--accentB); border: 1px solid rgba(123,166,255,.35); }

    .time { font-size: 1.8rem; font-variant-numeric: tabular-nums; font-weight: 800; }
    .sub { color: var(--muted); font-variant-numeric: tabular-nums; }

    .winner { border: 1px solid #244a32; background: linear-gradient(180deg, rgba(71,215,172,.12), rgba(71,215,172,.06)); color: #cffff2; }

    .log { height: 180px; overflow: auto; padding: 6px; border: 1px solid #1b2430; border-radius: 10px; background: rgba(12,18,26,.6); font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; font-size: .9rem; }
    .log p { margin: 4px 0; }

    .hint { font-size: .9rem; color: var(--muted); }
    .warn { color: var(--accentWarn); }
    .err { color: var(--accentErr); }
    .ok { color: var(--accentA); }

    .controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
    .controls > * { width: 100%; }

    .kpis { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 8px; }
    .kpi { text-align: center; padding: 8px; border: 1px solid #1b2430; border-radius: 12px; background: rgba(12,18,26,.6); }
    .kpi .label { font-size: .78rem; color: var(--muted); }
    .kpi .value { font-size: 1.1rem; font-weight: 700; }

    .toggle { display:flex; align-items:center; gap:8px; }
    input[type="number"] { width: 5.5em; padding: 8px; border-radius: 10px; border: 1px solid #243044; background: #0f141b; color: var(--text); }

    @media (max-width: 420px) {
      .time { font-size: 1.6rem; }
      button.big { font-size: 1.05rem; padding: 12px; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>üèÅ NFC Race Timer</h1>
      <div class="pill" id="support">Checking Web NFC‚Ä¶</div>
    </header>

    <div class="grid">
      <section class="card">
        <div class="row" style="gap:10px; align-items: stretch;">
          <button id="btnStart" class="primary big">üîÑ Start NFC Scan</button>
          <button id="btnArm" class="big">üö¶ Arm race</button>
          <button id="btnStop" class="ghost big" disabled>‚èπÔ∏è Stop</button>
        </div>
        <div style="height:10px"></div>
        <div class="row">
          <div class="status grow" id="status">Status: Ready</div>
        </div>
        <div class="kpis">
          <div class="kpi"><div class="label">State</div><div class="value" id="phase">idle</div></div>
          <div class="kpi"><div class="label">Debounce (ms)</div><div class="value"><input id="debounce" type="number" min="200" max="5000" step="50" value="800"/></div></div>
        </div>
      </section>

      <section class="card">
        <div class="hint">
          <strong>How it works:</strong>
          <ol>
            <li>Tap <em>‚ÄúStart NFC Scan‚Äù</em> and allow NFC access (Chrome/Android only, HTTPS).</li>
            <li>Tap <em>‚ÄúArm race‚Äù</em>.</li>
            <li>Roll both balls past the phone. The <u>first pass per ball</u> marks the start.</li>
            <li>On the <u>second pass</u> of the same ball, its lap time stops. The faster one wins.</li>
          </ol>
          <div class="warn">Tip: For reliable reads keep tags very close (1‚Äì3‚ÄØcm) to the phone‚Äôs NFC antenna (usually upper back).</div>
        </div>
      </section>

      <section class="card">
        <div class="lane a">
          <div>
            <h3>Ball A <span class="badge">A</span></h3>
            <div class="sub" id="idA">ID: ‚Äì</div>
          </div>
          <div class="time" id="timeA">‚Äì.-- s</div>
        </div>
        <div style="height:8px"></div>
        <div class="lane b">
          <div>
            <h3>Ball B <span class="badge">B</span></h3>
            <div class="sub" id="idB">ID: ‚Äì</div>
          </div>
          <div class="time" id="timeB">‚Äì.-- s</div>
        </div>
        <div style="height:10px"></div>
        <div id="winner" class="status">No winner yet.</div>
      </section>

      <section class="card">
        <div class="row" style="justify-content: space-between;">
          <div class="hint">Event Log</div>
          <div class="row">
            <button id="btnSimA" class="ghost">Sim A</button>
            <button id="btnSimB" class="ghost">Sim B</button>
            <button id="btnClearLog" class="ghost">Clear log</button>
          </div>
        </div>
        <div class="log" id="log" aria-live="polite"></div>
      </section>
    </div>
  </div>

  <script>
    const ui = {
      support: document.getElementById('support'),
      status: document.getElementById('status'),
      phase: document.getElementById('phase'),
      btnStart: document.getElementById('btnStart'),
      btnArm: document.getElementById('btnArm'),
      btnStop: document.getElementById('btnStop'),
      timeA: document.getElementById('timeA'),
      timeB: document.getElementById('timeB'),
      idA: document.getElementById('idA'),
      idB: document.getElementById('idB'),
      winner: document.getElementById('winner'),
      log: document.getElementById('log'),
      debounce: document.getElementById('debounce'),
      btnSimA: document.getElementById('btnSimA'),
      btnSimB: document.getElementById('btnSimB'),
      btnClearLog: document.getElementById('btnClearLog')
    };

    const state = {
      phase: 'idle', // idle | armed | running | finished
      controller: null,
      ndef: null,
      tags: new Map(), // id -> { label, first: number|undefined, lastTrig: number|0, passes: 0, lap: number|undefined }
      order: [], // id assignment order
    };

    // Utility -------------------------------------------------------------
    const fmt = (ms) => (ms==null? '‚Äì.-- s' : (ms/1000).toFixed(2)+' s');
    const nowPerf = () => performance.now();
    const log = (msg, cls='') => {
      const p = document.createElement('p');
      if (cls) p.className = cls;
      const t = new Date();
      p.textContent = `[${t.toLocaleTimeString()}] ${msg}`;
      ui.log.prepend(p);
    };
    const vibrate = (pattern) => { try { navigator.vibrate && navigator.vibrate(pattern); } catch(_){} };
    const beep = (() => {
      let ctx;
      return (duration=120, freq=880) => {
        try {
          ctx = ctx || new (window.AudioContext || window.webkitAudioContext)();
          const o = ctx.createOscillator();
          const g = ctx.createGain();
          o.frequency.value = freq; o.type = 'triangle';
          o.connect(g); g.connect(ctx.destination);
          g.gain.setValueAtTime(0.001, ctx.currentTime);
          g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime + 0.01);
          g.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration/1000);
          o.start(); o.stop(ctx.currentTime + duration/1000);
        } catch(_){}
      }
    })();

    function setPhase(p){ state.phase = p; ui.phase.textContent = p; }
    function resetRace(){
      state.tags.clear(); state.order = [];
      ui.timeA.textContent = '‚Äì.-- s'; ui.timeB.textContent = '‚Äì.-- s';
      ui.idA.textContent = 'ID: ‚Äì'; ui.idB.textContent = 'ID: ‚Äì';
      ui.winner.classList.remove('winner'); ui.winner.textContent = 'No winner yet.';
      setPhase('idle');
    }

    // NFC helpers --------------------------------------------------------
    function getTagId(ev){
      if (ev.serialNumber) return 'SN:' + ev.serialNumber;
      try {
        const parts = [];
        for (const r of ev.message.records) {
          if (r.id) parts.push('RID:'+r.id);
          if (r.recordType === 'text' && r.data) {
            const bytes = new Uint8Array(r.data.buffer, r.data.byteOffset, r.data.byteLength);
            const status = bytes[0];
            const langLen = status & 0x3F;
            const utf16 = (status & 0x80) !== 0;
            const txt = new TextDecoder(utf16? 'utf-16' : 'utf-8').decode(bytes.subarray(1+langLen));
            if (txt) parts.push('TXT:'+txt);
          }
        }
        if (parts.length) return parts.join('|');
      } catch(_) {}
      return 'TAG:UNKNOWN';
    }

    function ensureTag(id){
      if (!state.tags.has(id)){
        if (state.order.length >= 2) return null;
        const label = state.order.length === 0 ? 'A' : 'B';
        state.order.push(id);
        state.tags.set(id, { label, first: undefined, lastTrig: 0, passes: 0, lap: undefined });
        if (label === 'A') ui.idA.textContent = 'ID: ' + id; else ui.idB.textContent = 'ID: ' + id;
        log(`New tag detected ‚Üí Ball ${label} (${id})`, 'ok');
      }
      return state.tags.get(id);
    }

    function handlePass(id){
      const debounceMs = Number(ui.debounce.value || 800);
      const t = nowPerf();
      const tag = ensureTag(id);
      if (!tag) { log(`Third tag ignored (${id})`, 'warn'); return; }
      if (t - (tag.lastTrig||0) < debounceMs) return;
      tag.lastTrig = t;

      if (state.phase === 'idle') return;

      if (state.phase === 'armed') {
        tag.passes = 1; tag.first = t; beep(80, tag.label==='A'? 700:760); vibrate(20);
        log(`Start captured: Ball ${tag.label} (1st pass)`);
        if ([...state.tags.values()].filter(x => x.passes >= 1).length === 2) {
          setPhase('running'); log('Both balls started ‚Üí state "running"', 'ok');
        }
        updateTimes();
        return;
      }

      if (state.phase === 'running') {
        tag.passes++;
        if (tag.passes === 2 && tag.first != null) {
          tag.lap = t - tag.first; beep(150, 980); vibrate([30, 30, 30]);
          log(`Lap time Ball ${tag.label}: ${fmt(tag.lap)}`, 'ok');
          updateTimes();
          const vals = [...state.tags.values()];
          if (vals.length === 2 && vals.every(x => x.lap != null)) {
            const [ta, tb] = vals[0].label==='A' ? [vals[0], vals[1]] : [vals[1], vals[0]];
            declareWinner(ta, tb);
          }
          return;
        }
        return;
      }
    }

    function declareWinner(ta, tb){
      setPhase('finished');
      if (ta.lap === tb.lap) {
        ui.winner.textContent = `Tie: ${fmt(ta.lap)} vs ${fmt(tb.lap)}`;
      } else if (ta.lap < tb.lap) {
        ui.winner.textContent = `ü•á Winner: Ball A (${fmt(ta.lap)}) ¬∑ Ball B ${fmt(tb.lap)}`;
      } else {
        ui.winner.textContent = `ü•á Winner: Ball B (${fmt(tb.lap)}) ¬∑ Ball A ${fmt(ta.lap)}`;
      }
      ui.winner.classList.add('winner');
      log(ui.winner.textContent, 'ok');
    }

    function updateTimes(){
      const entries = [...state.tags.entries()];
      for (const [id, tag] of entries){
        const txt = tag.lap != null ? fmt(tag.lap) : (tag.passes>=1 ? 'running‚Ä¶' : '‚Äì.-- s');
        if (tag.label==='A') ui.timeA.textContent = txt; else ui.timeB.textContent = txt;
      }
    }

    // NFC lifecycle ------------------------------------------------------
    async function startScan(){
      if (!('NDEFReader' in window)){
        ui.status.innerHTML = 'Status: <span class="err">Web NFC is not supported.</span>'; return;
      }
      try{
        if (state.controller) state.controller.abort();
        state.controller = new AbortController();
        state.ndef = new NDEFReader();
        await state.ndef.scan({ signal: state.controller.signal });
        state.ndef.onreading = (ev) => { const id = getTagId(ev); handlePass(id); };
        state.ndef.onreadingerror = () => { log('Read error during NFC scan', 'err'); };
        ui.status.innerHTML = 'Status: <span class="ok">Scan active. Hold tags near the antenna.</span>';
        ui.btnStop.disabled = false;
      } catch (err){
        console.error(err);
        ui.status.innerHTML = `Status: <span class="err">Error starting: ${err?.message||err}</span>`;
      }
    }
    function stopScan(){
      if (state.controller) { try { state.controller.abort(); } catch(_){} }
      state.controller = null; state.ndef = null;
      ui.btnStop.disabled = true; ui.status.textContent = 'Status: Scan stopped';
    }

    // UI wiring ----------------------------------------------------------
    ui.btnStart.addEventListener('click', startScan);
    ui.btnStop.addEventListener('click', stopScan);
    ui.btnArm.addEventListener('click', () => { resetRace(); setPhase('armed'); log('Race armed: waiting for 1st pass per ball‚Ä¶', 'warn'); beep(60, 620); });

    ui.btnClearLog.addEventListener('click', () => { ui.log.innerHTML=''; });
    ui.btnSimA.addEventListener('click', () => simulate('SIM-A'));
    ui.btnSimB.addEventListener('click', () => simulate('SIM-B'));
    function simulate(id){ handlePass(id); }

    // Support check ------------------------------------------------------
    (function(){
      if ('NDEFReader' in window) {
        ui.support.textContent = 'Web NFC available (Chrome/Android)';
      } else {
        ui.support.innerHTML = 'Web NFC not available. <span class="warn">Chrome/Android only, requires HTTPS.</span>';
      }
    })();

    resetRace();
  </script>
</body>
</html>
